services:
  backrest:
    image: garethgeorge/backrest:latest
    container_name: backrest
    restart: unless-stopped
    environment:
      BACKREST_DATA: /data
      BACKREST_CONFIG: /config/config.json
      XDG_CACHE_HOME: /cache
      TZ: UTC
    volumes:
      - backrest-data:/data
      - backrest-config:/config
      - backrest-cache:/cache
      - backrest-tmp:/tmp
    ports:
      - "9898:9898"

  sidecar:
    image: ghcr.io/bioshazard/backrest-auto-labels:latest
    container_name: backrest-sidecar
    restart: unless-stopped
    environment:
      BACKREST_CONFIG: /etc/backrest/config.json
      BACKREST_VOLUME_PREFIX: /var/lib/docker/volumes
      BACKREST_DEFAULT_RETENTION: daily=7,weekly=4
      BACKREST_PLAN_ID_PREFIX: backrest_sidecar_
    volumes:
      - backrest-config:/etc/backrest
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker:/var/lib/docker:ro
    command:
      - daemon
      - --config
      - /etc/backrest/config.json
      - --with-events
      - --apply
    depends_on:
      - backrest

volumes:
  backrest-data:
  backrest-config:
  backrest-cache:
  backrest-tmp:
